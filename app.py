import streamlit as st
import pandas as pd
import requests

# 1. –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–µ–∫—Ä–µ—Ç—ã –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ Streamlit)
def send_telegram_msg(text):
    try:
        # –ú—ã –ø—Ä–æ—Å–∏–º Streamlit –¥–∞—Ç—å –Ω–∞–º –∑–Ω–∞—á–µ–Ω–∏–µ, 
        # –∫–æ—Ç–æ—Ä–æ–µ –ª–µ–∂–∏—Ç –ø–æ–¥ –∏–º–µ–Ω–µ–º "TELEGRAM_TOKEN"
        token = st.secrets["8374801663:AAHmqjjDbFs2F54FZqxXjYLpuRK1uTSlqp0"]
        chat_id = st.secrets["5291647690"]
        url = f"https://api.telegram.org/bot{token}/sendMessage?chat_id={chat_id}&text={text}"
        requests.get(url)
    except Exception as e:
        st.error(f"–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–µ–∫—Ä–µ—Ç–∞–º: {e}")

# –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
st.set_page_config(page_title="Smart Shygyn", page_icon="üíß")
st.title("üíß Smart Shygyn: –ò–ò-–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤–æ–¥—ã")
st.markdown("–°–∏—Å—Ç–µ–º–∞ —Ä–∞–Ω–Ω–µ–≥–æ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è —É—Ç–µ—á–µ–∫ –¥–ª—è –ñ–ö –∏ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞")

# 2. –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
uploaded_file = st.file_uploader("–ó–∞–≥—Ä—É–∑–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ —Å–æ —Å—á–µ—Ç—á–∏–∫–æ–≤ (.csv)", type="csv")

if uploaded_file is not None:
    df = pd.read_csv(uploaded_file)
    
    # –°—á–∏—Ç–∞–µ–º –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏
    total_leaks = df['Leak Status'].sum()
    lost_litres = df[df['Leak Status'] == 1]['Flow Rate (L/s)'].sum()
    # –¢–∞—Ä–∏—Ñ: –±–µ—Ä–µ–º —Å—Ä–µ–¥–Ω–∏–π –ø–æ –†–ö –¥–ª—è —é—Ä–ª–∏—Ü (–ø—Ä–∏–º–µ—Ä–Ω–æ 0.5 —Ç–µ–Ω–≥–µ –∑–∞ –ª–∏—Ç—Ä)
    money_lost = lost_litres * 0.5 
    
    # 3. –ì–ª–∞–≤–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ (–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã)
    col1, col2, col3 = st.columns(3)
    
    with col1:
        status = "üî¥ –ê–í–ê–†–ò–Ø" if total_leaks > 0 else "üü¢ –ù–û–†–ú–ê"
        st.metric("–°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã", status)
        
    with col2:
        st.metric("–ü–æ—Ç–µ—Ä—è–Ω–æ –≤–æ–¥—ã", f"{lost_litres:.1f} –ª")
        
    with col3:
        st.metric("–£–±—ã—Ç–∫–∏ (—Ç–µ–Ω–≥–µ)", f"{int(money_lost)} ‚Ç∏", delta=f"-{int(money_lost)}", delta_color="inverse")

    # 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Ç–µ—á–∫–∏ –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    if total_leaks > 0:
        st.error(f"‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ! –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ {int(total_leaks)} –∞–Ω–æ–º–∞–ª—å–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π.")
        
        # –ö–Ω–æ–ø–∫–∞ –¥–ª—è —Ä—É—á–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç—á–µ—Ç–∞ (—á—Ç–æ–±—ã –Ω–µ —Å–ø–∞–º–∏—Ç—å –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∫–ª–∏–∫–µ)
        if st.button("–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á–µ—Ç –¥–∏—Å–ø–µ—Ç—á–µ—Ä—É –≤ Telegram"):
            report = (
                f"‚ö†Ô∏è –¢–†–ï–í–û–ì–ê: Smart Shygyn –æ–±–Ω–∞—Ä—É–∂–∏–ª —É—Ç–µ—á–∫—É!\n"
                f"üíß –ü–æ—Ç–µ—Ä—è–Ω–æ: {lost_litres:.1f} –ª\n"
                f"üí∏ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π —É—â–µ—Ä–±: {int(money_lost)} —Ç–µ–Ω–≥–µ\n"
                f"üìç –°—Ç–∞—Ç—É—Å: –¢—Ä–µ–±—É–µ—Ç—Å—è –≤—ã–µ–∑–¥ –º–∞—Å—Ç–µ—Ä–∞."
            )
            send_telegram_msg(report)
            st.success("–û—Ç—á–µ—Ç —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!")

    # 5. –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è
    st.subheader("–ê–Ω–∞–ª–∏–∑ –ø–æ—Ç–æ–∫–∞ –∏ –¥–∞–≤–ª–µ–Ω–∏—è (–î–∞–Ω–Ω—ã–µ IoT)")
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –≤–∞–∂–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–µ
    chart_data = df[['Flow Rate (L/s)', 'Pressure (bar)']].head(500)
    st.line_chart(chart_data)

    # 6. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –ò–ò
    st.info("üí° **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –ò–ò:** –ù–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ Anomaly Score –≤—ã—è–≤–ª–µ–Ω–æ –Ω–∞—Ä—É—à–µ–Ω–∏–µ –≥–µ—Ä–º–µ—Ç–∏—á–Ω–æ—Å—Ç–∏. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –≤ –°–µ–∫—Ç–æ—Ä–µ 4.")

else:
    st.warning("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª .csv (–¥–∞—Ç–∞—Å–µ—Ç) –¥–ª—è –Ω–∞—á–∞–ª–∞ –∞–Ω–∞–ª–∏–∑–∞.")
