# --- –£–ú–ù–ê–Ø –ê–ù–ê–õ–ò–¢–ò–ö–ê (–í–°–¢–ê–í–ò–¢–¨ –í–ú–ï–°–¢–û –°–¢–ê–†–´–• –†–ê–°–ß–ï–¢–û–í) ---

if df is not None:
    # 1. –û—á–∏—Å—Ç–∫–∞ –∏ —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ (—É–±–∏—Ä–∞–µ–º —à—É–º –¥–∞—Ç—á–∏–∫–æ–≤)
    # –°—á–∏—Ç–∞–µ–º —Å–∫–æ–ª—å–∑—è—â–µ–µ —Å—Ä–µ–¥–Ω–µ–µ –ø–æ 3 —Ç–æ—á–∫–∞–º
    df['Smooth_P'] = df['Pressure (bar)'].rolling(window=3).mean()
    df['Smooth_F'] = df['Flow Rate (L/s)'].rolling(window=3).mean()
    
    # 2. –õ–û–ì–ò–ö–ê –î–ï–¢–ï–ö–¶–ò–ò (–°–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –ò–ò-–∞–ª–≥–æ—Ä–∏—Ç–º)
    # –£—Å–ª–æ–≤–∏–µ: –î–∞–≤–ª–µ–Ω–∏–µ –Ω–∏–∂–µ 2.5 –±–∞—Ä –ò –ø–æ—Ç–æ–∫ –≤—ã—à–µ —Å—Ä–µ–¥–Ω–µ–≥–æ –Ω–∞ 20%
    mean_flow = df['Smooth_F'].mean()
    
    # –°–æ–∑–¥–∞–µ–º –º–∞—Å–∫—É –∞–Ω–æ–º–∞–ª–∏–π (–ø—Ä–æ–≥—Ä–∞–º–º–∞ —Å–∞–º–∞ —Ä–µ—à–∞–µ—Ç, –≥–¥–µ –∞–≤–∞—Ä–∏—è)
    df['AI_Leak_Detected'] = (df['Smooth_P'] < 2.5) & (df['Smooth_F'] > mean_flow * 1.2)
    
    # –°—á–∏—Ç–∞–µ–º –∏—Ç–æ–≥–∏ –ø–æ –Ω–∞—à–µ–º—É AI, –∞ –Ω–µ –ø–æ –º–µ—Ç–∫–∞–º –≤ —Ñ–∞–π–ª–µ
    total_leaks = int(df['AI_Leak_Detected'].sum())
    
    # –°—á–∏—Ç–∞–µ–º –æ–±—ä–µ–º –ø–æ—Ç–µ—Ä—å —Ç–æ–ª—å–∫–æ —Ç–∞–º, –≥–¥–µ –Ω–∞—à AI —É–≤–∏–¥–µ–ª –∞–≤–∞—Ä–∏—é
    lost_litres = df[df['AI_Leak_Detected'] == True]['Flow Rate (L/s)'].sum() * 3600 # –≤ —á–∞—Å
    money_lost = int(lost_litres * 0.5)

    # --- –í–ò–ó–£–ê–õ–ò–ó–ê–¶–ò–Ø –ú–ï–¢–†–ò–ö ---
    col1, col2, col3 = st.columns(3)
    
    # –°—Ç–∞—Ç—É—Å —Ç–µ–ø–µ—Ä—å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –Ω–∞—à–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
    if total_leaks > 0:
        col1.error("üî¥ –ê–í–ê–†–ò–Ø –ù–ê–ô–î–ï–ù–ê")
        st.sidebar.warning(f"AI –æ–±–Ω–∞—Ä—É–∂–∏–ª {total_leaks} –∞–Ω–æ–º–∞–ª—å–Ω—ã—Ö —Å–µ–≥–º–µ–Ω—Ç–æ–≤")
    else:
        col1.success("üü¢ –°–ò–°–¢–ï–ú–ê –í –ù–û–†–ú–ï")

    col2.metric("–ü–æ—Ç–µ—Ä–∏ –≤–æ–¥—ã (AI)", f"{lost_litres:.1f} –ª")
    col3.metric("–£–±—ã—Ç–∫–∏", f"{money_lost} ‚Ç∏")

    # –ì—Ä–∞—Ñ–∏–∫ —Å –∑–æ–Ω–∞–º–∏ –∞–Ω–æ–º–∞–ª–∏–π
    st.subheader("üìä –ê–Ω–∞–ª–∏–∑ –≥–∏–¥—Ä–∞–≤–ª–∏—á–µ—Å–∫–∏—Ö –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–π")
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ—á–∫–∏, –≥–¥–µ AI –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–ª –ø—Ä–æ–±–ª–µ–º—É
    st.line_chart(df[['Smooth_P', 'Smooth_F']])
    
    if total_leaks > 0:
        st.info("ü§ñ **–ê–Ω–∞–ª–∏–∑ –ò–ò:** –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ —Ä–µ–∑–∫–æ–µ –ø–∞–¥–µ–Ω–∏–µ –¥–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏ –∞–Ω–æ–º–∞–ª—å–Ω–æ–º —Ä–æ—Å—Ç–µ —Ä–∞—Å—Ö–æ–¥–∞. –≠—Ç–æ –Ω–µ –ø–æ—Ö–æ–∂–µ –Ω–∞ –æ–±—ã—á–Ω–æ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–¥–≤–∏–∂–µ–∫.")
